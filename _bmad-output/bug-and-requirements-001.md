# Bug Report & Requirements: BUG-001

**Date:** 2025-12-26
**Reporter:** mr lu (via Mary, Business Analyst)
**Priority:** High
**Status:** COMPLETED

---

## Part 1: Bug Report

### Summary
`PaperTradingPersistenceService` is missing the `start()` method required by the service container lifecycle.

### Error Message
```
AttributeError: 'PaperTradingPersistenceService' object has no attribute 'start'
```

### Impact
- **Severity:** Critical - Application fails to start
- **Affected Component:** Backend server startup
- **User Impact:** Cannot launch the trading system

### Root Cause Location
| File | Line | Issue |
|------|------|-------|
| `src/infrastructure/container.py` | 573 | Calls `await service.start()` |
| `src/infrastructure/container.py` | 171 | `_get_or_create_singleton_async` propagates error |
| Service class | ? | Missing `start()` method implementation |

### Stack Trace Summary
```
container.py:573 → await service.start()  ← FAILS HERE
container.py:577 → create_paper_trading_persistence_service()
container.py:1137 → create_unified_trading_controller()
unified_server.py:181 → lifespan context
```

### Expected Fix
Add `async def start(self)` method to `PaperTradingPersistenceService` class (or adjust container logic if service doesn't need startup).

---

## Part 2: Launch Mechanism Change Request

### Current State
- Program launched via `.\start_all.ps1`
- Uses `Start-Process` to spawn separate windows:
  - QuestDB: `Start-Process -FilePath questdb.exe`
  - Backend: `Start-Process python -ArgumentList "uvicorn..."`
  - Frontend: `Start-Process powershell -ArgumentList "npm run dev"`

### Problem
- Each process runs in **separate window**
- AI agents **cannot access window content**
- Agents cannot:
  - See startup errors
  - Capture logs
  - Debug issues automatically
  - Verify successful startup

### Requirements for New Launch Mechanism

#### REQ-1: Agent-Accessible Output
Agent must be able to capture stdout/stderr from all processes.

#### REQ-2: Unified or Redirected Logging
Options to consider:
| Option | Description | Pros | Cons |
|--------|-------------|------|------|
| **A) Log files** | Redirect output to files | Simple, persistent | Agent must read files |
| **B) Single terminal** | Run all in same terminal | Direct access | Cluttered output |
| **C) Subprocess with pipes** | Capture via Python subprocess | Full control | More complex |
| **D) Hybrid** | Log files + tail in terminal | Best of both | Slightly complex |

#### REQ-3: Preserve Functionality
- QuestDB health check must still work
- Backend must start on port 8080
- Frontend must start on port 3000
- Browser auto-open can be optional

#### REQ-4: Error Visibility
When backend fails (like BUG-001), agent should be able to:
1. See the error immediately
2. Capture full stack trace
3. Take corrective action

### Suggested Implementation Approach
1. Create log directory: `logs/` or similar
2. Modify `start_all.ps1` to redirect output:
   ```powershell
   # Example for backend
   Start-Process python -ArgumentList "..." -RedirectStandardOutput "logs/backend.log" -RedirectStandardError "logs/backend_error.log"
   ```
3. Or create Python-based launcher that uses `subprocess.Popen` with `stdout=PIPE`

---

## Acceptance Criteria

### Bug Fix (BUG-001)
- [x] Backend starts without `AttributeError`
- [x] `PaperTradingPersistenceService` has proper lifecycle methods
- [x] All services initialize correctly

### Launch Mechanism
- [x] Agent can read backend startup output (logs/backend.log)
- [x] Agent can read frontend startup output (logs/frontend.log)
- [x] Errors are captured and accessible (logs/backend_error.log)
- [x] Existing functionality preserved

---

## Files to Investigate

1. `src/infrastructure/container.py` - Service creation logic
2. `src/services/paper_trading_persistence_service.py` (or similar) - Missing start() method
3. `start_all.ps1` - Launch script to modify
4. Other services in container - Check pattern for `start()` method

---

## Handoff Notes for Dev Agent

1. **Bug first** - Fix the `start()` method issue so backend can run
2. **Then launch mechanism** - Modify how processes are started
3. **Test** - Verify agent can capture output after changes

**Recommended command to invoke dev:**
```
/bmad:bmm:agents:dev
```

---

*Document generated by Mary (Business Analyst) - BMAD Framework*
