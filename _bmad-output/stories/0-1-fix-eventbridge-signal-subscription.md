# Story 0.1: Fix EventBridge Signal Subscription

Status: in-progress

## Story

As a **trader**,
I want **signals generated by the StrategyManager to be forwarded to the WebSocket clients**,
so that **I can see signals appear on my dashboard in real-time**.

## Acceptance Criteria

1. **AC1:** When StrategyManager publishes a `signal_generated` event, the EventBridge forwards it to WebSocket clients within 500ms
2. **AC2:** Signal data includes: signal_type, symbol, timestamp, section (S1/O1/Z1/ZE1/E1), indicator values
3. **AC3:** Frontend receives signal via WebSocket and can log it to browser console
4. **AC4:** No silent failures - if forwarding fails, error is logged with context
5. **AC5:** Dead code (old signal handlers) is cleaned up or documented

## Tasks / Subtasks

- [x] **Task 1: Verify Current Fix Status** (AC: 1)
  - [x] 1.1 Confirm `signal_generated` handler exists at `event_bridge.py:638-644`
  - [x] 1.2 Trace signal flow: StrategyManager → EventBus → EventBridge → WebSocket
  - [x] 1.3 Document current implementation status

- [ ] **Task 2: Write E2E Verification Test** (AC: 1, 3)
  - [ ] 2.1 Create test that triggers StrategyManager signal generation
  - [ ] 2.2 Assert EventBridge receives and processes signal
  - [ ] 2.3 Assert WebSocket client receives signal message
  - [ ] 2.4 Measure latency (must be < 500ms)

- [ ] **Task 3: Verify Signal Data Schema** (AC: 2)
  - [ ] 3.1 Confirm signal payload includes required fields
  - [ ] 3.2 Validate against expected schema from `core/event_bus.py:40`
  - [ ] 3.3 Document actual signal structure for frontend team

- [ ] **Task 4: Clean Up Dead Code** (AC: 5)
  - [ ] 4.1 Review handlers at `event_bridge.py:605-618` and `631-636`
  - [ ] 4.2 Either remove dead handlers or add TODO comments explaining future use
  - [ ] 4.3 Ensure removal doesn't break any tests

- [ ] **Task 5: Add Error Handling** (AC: 4)
  - [ ] 5.1 Add try/catch with logging to `handle_signal_generated`
  - [ ] 5.2 Ensure errors propagate to monitoring/logs
  - [ ] 5.3 Test error scenario

## Dev Notes

### Current State Analysis (IMPORTANT)

**The fix appears to have been partially applied.** Analysis of `src/api/event_bridge.py` shows:

- **Lines 638-644:** A `signal_generated` handler EXISTS and subscribes correctly
- **Lines 631-636:** Old handlers for `signal.flash_pump_detected`, `signal.reversal_detected`, `signal.confluence_detected` still exist but are DEAD CODE (StrategyManager never publishes these events)

**Verification Priority:** This story is primarily about VERIFYING the fix works E2E, not implementing it from scratch.

### Signal Flow Architecture

```
StrategyManager._publish_signal_generated()
    ↓
event_bus.publish("signal_generated", signal_event)  [strategy_manager.py:2248]
    ↓
EventBridge.handle_signal_generated()                [event_bridge.py:639-641]
    ↓
EventBridge._process_event("signal_generated", data)
    ↓
WebSocket broadcast to subscribed clients
    ↓
Frontend Zustand store receives signal
```

### Key Files to Touch

| File | Action | Lines |
|------|--------|-------|
| `src/api/event_bridge.py` | Verify/Clean | 605-644 |
| `tests/integration/test_signal_flow.py` | Create | New file |
| `src/domain/services/strategy_manager.py` | Read-only | 2163-2250 |

### Pattern Requirements (from Architecture)

**MUST Follow:**
- Use `snake_case` for all Python variables and event names
- Use response envelope for WebSocket messages
- Log all errors with context via structured logging
- Follow existing EventBus subscription patterns

**Signal Event Schema (from `core/event_bus.py:40`):**
```python
"signal_generated": {
    "signal_type": str,    # "S1", "O1", "Z1", "ZE1", "E1"
    "symbol": str,         # "BTCUSDT"
    "section": str,        # Same as signal_type
    "timestamp": str,      # ISO8601
    "indicators": dict,    # Indicator values at signal time
    "metadata": dict       # Additional context
}
```

### Testing Standards

- Create integration test in `tests/integration/`
- Use pytest with async support (`pytest-asyncio`)
- Mock WebSocket client for E2E verification
- Test both success and failure scenarios

### Previous Commit Context

Recent commits show API integration fixes (`ff9475b`). Verify this didn't break signal flow.

### Project Structure Notes

- Backend follows Clean Architecture: `/src/api/` → `/src/domain/` → `/src/infrastructure/`
- Event flow uses EventBus pub/sub pattern defined in `/src/core/event_bus.py`
- WebSocket server at `/src/api/websocket_server.py`

### References

- [Source: _bmad-output/architecture.md#Decision 3: Signal Pipeline Integration]
- [Source: _bmad-output/architecture.md#Implementation Sequence]
- [Source: _bmad-output/prd.md#FR18: Trader can view generated signals]
- [Source: _bmad-output/epics.md#Epic 0 Story 1]
- [Source: src/api/event_bridge.py:638-644]
- [Source: src/domain/services/strategy_manager.py:2163-2250]
- [Source: src/core/event_bus.py:40]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

**Task 1 Completed (2025-12-26):**
- ✅ Verified `signal_generated` handler exists at `event_bridge.py:638-644`
- ✅ Traced full signal flow: StrategyManager → EventBus → EventBridge → WebSocket
- ✅ Finding: Implementation is ALREADY COMPLETE
- Signal flow: `strategy_manager.py:2248` publishes → `event_bridge.py:639` receives → `broadcast_provider` forwards
- Dead code identified: Lines 605-636 contain handlers for old event types (`signal.flash_pump_detected`, etc.) that StrategyManager never publishes

### File List
