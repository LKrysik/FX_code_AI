# Story 1B-2: Backtest Execution Engine

**Status:** review
**Priority:** P0 (MVP)
**Epic:** Epic 1B - First Successful Backtest

---

## Story

As a **trader**,
I want **the system to execute my strategy against historical data**,
So that **I can see how my strategy would have performed in the past**.

---

## Context

Story 1b-1 created the backtest setup form and `/api/backtest/start` endpoint. The endpoint currently:
1. Creates a session record in `backtest_sessions` table
2. Returns `session_id` with status "started"
3. Has a TODO comment: "Trigger backtest execution via message queue or async task"

This story implements the actual backtest execution logic.

---

## Acceptance Criteria

1. **AC1:** BacktestEngine processes historical tick data through the strategy
2. **AC2:** Signals generated by strategy trigger orders via BacktestOrderManager
3. **AC3:** Session status updates: started → running → completed/failed
4. **AC4:** Progress is tracked (% complete based on time processed)
5. **AC5:** Results are stored: trades, P&L, equity curve
6. **AC6:** Execution respects acceleration_factor (10x = 1 day in ~8.6 seconds)
7. **AC7:** Engine handles errors gracefully and marks session as failed
8. **AC8:** WebSocket broadcasts progress updates to frontend

---

## Tasks / Subtasks

- [x] Task 1: Create BacktestEngine class (AC: 1, 2)
  - [x] Load historical data via BacktestMarketDataProvider
  - [x] Initialize strategy with historical context
  - [x] Process data tick-by-tick or candle-by-candle
  - [x] Feed data to strategy and collect signals
  - [x] Execute signals via BacktestOrderManager

- [x] Task 2: Implement session status management (AC: 3, 4)
  - [x] Update session status in backtest_sessions table
  - [x] Track progress_pct based on timestamp processed
  - [x] Handle completion and failure states

- [x] Task 3: Implement results storage (AC: 5)
  - [x] Store trades in backtest_trades table
  - [x] Calculate final P&L and statistics
  - [x] Store equity curve snapshots

- [x] Task 4: Add acceleration control (AC: 6)
  - [x] Respect acceleration_factor from config
  - [x] Add sleep between batches to simulate time passage
  - [x] Allow real-time or max-speed modes

- [x] Task 5: Error handling and recovery (AC: 7)
  - [x] Wrap execution in try/except
  - [x] Mark session as "failed" with error message
  - [x] Log detailed error information

- [x] Task 6: WebSocket progress updates (AC: 8)
  - [x] Broadcast progress updates every N seconds
  - [x] Send completion/failure events
  - [x] Include current P&L in updates

- [x] Task 7: Integration with /api/backtest/start (AC: all)
  - [x] Trigger BacktestEngine as async task
  - [x] Return immediately with session_id
  - [x] Engine runs in background

---

## Technical Design

### BacktestEngine Class

```python
class BacktestEngine:
    """
    Executes backtests by processing historical data through a strategy.

    Flow:
    1. Load session config from database
    2. Initialize data provider with date range
    3. Load and initialize strategy
    4. Process historical data tick-by-tick
    5. Generate signals and execute orders
    6. Track P&L and update progress
    7. Store results and mark complete
    """

    def __init__(
        self,
        session_id: str,
        db_provider: QuestDBProvider,
        event_bus: EventBus,
        logger: StructuredLogger
    ):
        self.session_id = session_id
        self.db_provider = db_provider
        self.event_bus = event_bus
        self.logger = logger

        # Components initialized during run()
        self.data_provider: BacktestMarketDataProvider
        self.order_manager: BacktestOrderManager
        self.strategy: BaseStrategy

    async def run(self) -> BacktestResult:
        """Execute the backtest and return results."""
        pass
```

### Database Tables

```sql
-- Existing: backtest_sessions (from 1b-1)
-- Add columns for results
ALTER TABLE backtest_sessions ADD COLUMN IF NOT EXISTS
    progress_pct FLOAT DEFAULT 0,
    current_timestamp TIMESTAMP,
    final_pnl FLOAT,
    total_trades INT,
    win_rate FLOAT,
    completed_at TIMESTAMP,
    error_message STRING;

-- New: backtest_trades
CREATE TABLE IF NOT EXISTS backtest_trades (
    trade_id STRING,
    session_id STRING,
    symbol STRING,
    order_type STRING,
    quantity FLOAT,
    entry_price FLOAT,
    exit_price FLOAT,
    pnl FLOAT,
    entry_time TIMESTAMP,
    exit_time TIMESTAMP,
    strategy_signal STRING,
    timestamp TIMESTAMP
) TIMESTAMP(timestamp) PARTITION BY DAY;

-- New: backtest_equity_curve
CREATE TABLE IF NOT EXISTS backtest_equity_curve (
    session_id STRING,
    timestamp TIMESTAMP,
    equity FLOAT,
    drawdown_pct FLOAT,
    open_positions INT
) TIMESTAMP(timestamp) PARTITION BY DAY;
```

### WebSocket Events

```typescript
// Progress update
{
  type: "backtest.progress",
  data: {
    session_id: "bt_xxx",
    progress_pct: 45.5,
    current_timestamp: "2025-11-03T14:30:00Z",
    current_pnl: 1234.56,
    open_positions: 1
  }
}

// Completion
{
  type: "backtest.completed",
  data: {
    session_id: "bt_xxx",
    final_pnl: 2500.00,
    total_trades: 42,
    win_rate: 0.62,
    duration_seconds: 125
  }
}

// Failure
{
  type: "backtest.failed",
  data: {
    session_id: "bt_xxx",
    error: "Strategy initialization failed: missing indicator config"
  }
}
```

### Files to Create/Modify

**New files:**
- `src/trading/backtest_engine.py` - Main BacktestEngine class
- `tests/unit/test_backtest_engine.py` - Unit tests

**Modify:**
- `src/api/backtest_routes.py` - Trigger engine from /start endpoint
- `src/api/unified_server.py` - Initialize engine dependencies

---

## Dependencies

- Story 1b-1 (completed): BacktestSetupForm, /api/backtest/start
- Existing: BacktestOrderManager, BacktestMarketDataProvider
- Existing: Strategy infrastructure (BaseStrategy, IndicatorEngine)

---

## Definition of Done

1. [x] BacktestEngine processes historical data correctly
2. [x] Signals from strategy trigger trades
3. [x] Session status updates in real-time
4. [x] Progress tracked and broadcast via WebSocket
5. [x] Results (trades, P&L) stored in database
6. [x] Acceleration factor controls execution speed
7. [x] Errors handled gracefully
8. [x] Unit tests for engine logic (31 tests passing)
9. [ ] Integration test for full backtest flow (deferred to E2E)

---

## Dev Agent Record

### Implementation Summary

Implemented complete BacktestEngine with the following components:

1. **BacktestEngine class** (`src/trading/backtest_engine.py`)
   - Loads session configuration from QuestDB
   - Loads strategy configuration with fallback to defaults
   - Processes historical candles from BacktestMarketDataProvider
   - Evaluates entry/exit signals based on momentum and volume
   - Executes trades via BacktestOrderManager
   - Tracks equity curve and drawdown
   - Stores trades and equity curve to database
   - Broadcasts progress via EventBus (backtest.progress, backtest.completed, backtest.failed)

2. **API Integration** (`src/api/backtest_routes.py`)
   - Modified `/api/backtest/start` to trigger BacktestEngine as async background task
   - Added `/api/backtest/sessions/{session_id}/stop` endpoint to stop running backtests
   - Added `/api/backtest/active` endpoint to list running backtests
   - Added EventBus dependency injection

3. **Data Classes**
   - `BacktestConfig` - Session configuration
   - `BacktestProgress` - Progress tracking with serialization
   - `BacktestResult` - Final results with metrics
   - `TradeRecord` - Individual trade records
   - `EquityPoint` - Equity curve data points

### Signal Logic

Entry signals (S1):
- Price momentum > 0.1%
- Volume ratio > 1.5x average

Exit signals:
- E1 (Emergency): Stop loss at -5%
- ZE1 (Take Profit): Take profit at +10%

### WebSocket Events

```json
// backtest.progress
{
  "type": "backtest.progress",
  "data": {
    "session_id": "bt_xxx",
    "progress_pct": 45.5,
    "current_pnl": 1234.56,
    "equity": 11234.56
  }
}

// backtest.completed
{
  "type": "backtest.completed",
  "data": {
    "session_id": "bt_xxx",
    "final_pnl": 2500.00,
    "total_trades": 42,
    "win_rate": 0.62
  }
}

// backtest.failed
{
  "type": "backtest.failed",
  "data": {
    "session_id": "bt_xxx",
    "error": "Error message"
  }
}
```

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/trading/backtest_engine.py` | Created | BacktestEngine class with all execution logic |
| `src/api/backtest_routes.py` | Modified | Added engine integration, stop endpoint, active list |
| `tests/unit/test_backtest_engine.py` | Created | 31 unit tests for engine logic |

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-31 | Amelia (Dev) | Story created based on 1b-1 TODO |
| 2025-12-31 | Amelia (Dev) | Implemented BacktestEngine class with all 7 tasks |
| 2025-12-31 | Amelia (Dev) | Created 31 unit tests, all passing |
| 2025-12-31 | Amelia (Dev) | Story ready for code review |
